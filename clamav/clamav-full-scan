#!/bin/bash

# ClamAV Full Scan - Enhanced with completion notifications
# Runs a comprehensive scan of the user's home directory

# Define paths and user
# Resolve clamscan dynamically (fallback to previous path if not found)
CLAMSCAN_BIN="$(command -v clamscan || echo /usr/local/bin/clamscan)"
USER_NAME="hcnureth"
LOG_DIR="/home/$USER_NAME/.local/share/clamav"
DATE_STAMP=$(date +%Y-%m-%d_%H-%M-%S)

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Source shared notification and logging functions
source "$(dirname "$0")/clamav_notifications.sh"
source "$(dirname "$0")/clamav_logging.sh"

# Create a temporary file to hold the list of files
TEMP_FILE=$(mktemp)

# Record start time
START_TIME=$(date +%s)
START_TIME_READABLE=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$START_TIME_READABLE] ClamAV Full Scan Started" >> "$LOG_DIR/scan_history.log"

# Check if online (basic connectivity test)
if ! ping -c 1 8.8.8.8 &> /dev/null; then
    echo "[$START_TIME_READABLE] Full scan skipped - no internet connection" >> "$LOG_DIR/scan_history.log"
    exit 0
fi

# Use find to get the list of files and redirect it to the temporary file
sudo -u root find /home/"$USER_NAME" -not -path "/home/$USER_NAME/.vscode/extensions/*" -not -path "/home/$USER_NAME/.cache/*" -not -path "/home/$USER_NAME/.local/share/Trash/*" -type f -print > "$TEMP_FILE" 2>/dev/null

# Count files to scan
FILE_COUNT=$(wc -l < "$TEMP_FILE")

# Run the full scan on the list of files from the temporary file
FULL_SCAN_OUTPUT=$(sudo -u root "$CLAMSCAN_BIN" -f "$TEMP_FILE" --no-summary 2>&1)
SCAN_EXIT_CODE=$?

# Calculate scan duration
END_TIME=$(date +%s)
END_TIME_READABLE=$(date '+%Y-%m-%d %H:%M:%S')
DURATION=$((END_TIME - START_TIME))
DURATION_MIN=$((DURATION / 60))

# Get the infected files from the full scan output
INFECTED_FILES=$(echo "$FULL_SCAN_OUTPUT" | grep "FOUND")
INFECTED_COUNT=$(echo "$INFECTED_FILES" | grep -c "FOUND" || echo "0")

# Log completion
echo "[$END_TIME_READABLE] Full scan completed - Files: $FILE_COUNT, Duration: ${DURATION_MIN}m, Infected: $INFECTED_COUNT" >> "$LOG_DIR/scan_history.log"

# Send appropriate notification based on results
if [ -n "$INFECTED_FILES" ] && [ "$INFECTED_COUNT" -gt 0 ]; then
    # Virus found - log to home directory and create detailed results

    # Log virus detections to home directory log file
    local virus_log_file=$(log_multiple_viruses "$FULL_SCAN_OUTPUT")
    if [[ -n "$virus_log_file" ]]; then
        echo "[$END_TIME_READABLE] Virus details logged to: $virus_log_file" >> "$LOG_DIR/scan_history.log"
    fi

    # Create detailed scan results in ClamAV log directory
    RESULTS_FILE="$LOG_DIR/virus_scan_results_$DATE_STAMP.log"
    echo "ClamAV Full Scan Results - $START_TIME_READABLE" > "$RESULTS_FILE"
    echo "Scan Duration: ${DURATION_MIN} minutes" >> "$RESULTS_FILE"
    echo "Files Scanned: $FILE_COUNT" >> "$RESULTS_FILE"
    echo "Infected Files Found: $INFECTED_COUNT" >> "$RESULTS_FILE"
    echo "----------------------------------------" >> "$RESULTS_FILE"
    echo "$INFECTED_FILES" >> "$RESULTS_FILE"

    # Send notification using shared function
    send_scheduled_scan_notification "Full Scan" "$FILE_COUNT" "${DURATION_MIN} minutes" "$INFECTED_COUNT" "$RESULTS_FILE"
else
    # Send clean scan notification using shared function
    send_scheduled_scan_notification "Full Scan" "$FILE_COUNT" "${DURATION_MIN} minutes" "0"
fi

# Clean up the temporary file
rm "$TEMP_FILE"
